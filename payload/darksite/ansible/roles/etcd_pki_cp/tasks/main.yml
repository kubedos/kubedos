---
# Copy etcd client PKI (for kube-apiserver talking to etcd) to control-plane nodes.
# Source artifacts are produced on the controller under /srv/ansible/artifacts/etcd-pki

- name: Build etcd PKI (CA + per-node certs)
  ansible.builtin.include_tasks: pki.yml

- name: Ensure /etc/kubernetes/pki/etcd exists
  ansible.builtin.file:
    path: /etc/kubernetes/pki/etcd
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Define etcd client PKI artifact paths (controller)
  ansible.builtin.set_fact:
    etcd_client_pki:
      - { src: "/srv/ansible/artifacts/etcd-pki/ca.crt",                  dest: "/etc/kubernetes/pki/etcd/ca.crt",                  mode: "0644" }
      - { src: "/srv/ansible/artifacts/etcd-pki/apiserver-etcd-client.crt", dest: "/etc/kubernetes/pki/apiserver-etcd-client.crt",     mode: "0644" }
      - { src: "/srv/ansible/artifacts/etcd-pki/apiserver-etcd-client.key", dest: "/etc/kubernetes/pki/apiserver-etcd-client.key",     mode: "0640" }

- name: Assert etcd client PKI artifacts exist on controller
  ansible.builtin.stat:
    path: "{{ item.src }}"
  register: _etcd_client_pki_stats
  loop: "{{ etcd_client_pki }}"
  delegate_to: localhost

- name: Fail if etcd client PKI artifact missing on controller
  ansible.builtin.fail:
    msg: "Missing etcd client PKI artifact on controller: {{ item.item.src }}"
  when: not item.stat.exists
  loop: "{{ _etcd_client_pki_stats.results }}"

# Critical change: slurp on controller, then copy via content
- name: Read etcd client PKI artifacts from controller (base64)
  ansible.builtin.slurp:
    src: "{{ item.src }}"
  register: _etcd_client_pki_slurped
  loop: "{{ etcd_client_pki }}"
  delegate_to: localhost

- name: Copy etcd client PKI to control-plane node (from slurped content)
  ansible.builtin.copy:
    content: "{{ item.content | b64decode }}"
    dest: "{{ item.item.dest }}"
    owner: root
    group: root
    mode: "{{ item.item.mode }}"
  loop: "{{ _etcd_client_pki_slurped.results }}"

