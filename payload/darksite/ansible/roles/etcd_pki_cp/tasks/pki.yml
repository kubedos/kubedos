---
# etcd PKI (OpenSSL, deterministic)
# - CA generated once on first etcd node, then distributed
# - Per-node peer + server certs include SANs for:
#   - etcd_bind_ip (etcd_ip preferred, fallback underlay_ip)
#   - 127.0.0.1
#   - inventory hostname + shortname

- name: Compute etcd bind IP (must match SANs + etcd.conf.yml)
  ansible.builtin.set_fact:
    etcd_bind_ip: "{{ etcd_ip | default(underlay_ip) }}"

- name: Ensure etcd PKI dir exists
  ansible.builtin.file:
    path: /etc/etcd/pki
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Ensure openssl is present
  ansible.builtin.package:
    name: openssl
    state: present

# --- CA on first etcd node ---
- name: Generate CA key (first etcd only)
  ansible.builtin.command: openssl genrsa -out /etc/etcd/pki/ca.key 4096
  args:
    creates: /etc/etcd/pki/ca.key
  when: inventory_hostname == (groups['etcd'] | first)

- name: Generate CA cert (first etcd only)
  ansible.builtin.command: >
    openssl req -x509 -new -nodes
    -key /etc/etcd/pki/ca.key
    -subj "/CN=etcd-ca"
    -days 3650
    -out /etc/etcd/pki/ca.crt
  args:
    creates: /etc/etcd/pki/ca.crt
  when: inventory_hostname == (groups['etcd'] | first)

- name: Fetch CA artifacts to controller (first etcd only)
  ansible.builtin.fetch:
    src: "/etc/etcd/pki/{{ item }}"
    dest: "/tmp/etcd-pki/{{ item }}"
    flat: true
  loop:
    - ca.key
    - ca.crt
  when: inventory_hostname == (groups['etcd'] | first)

- name: Distribute CA artifacts to all etcd nodes
  ansible.builtin.copy:
    src: "/tmp/etcd-pki/{{ item }}"
    dest: "/etc/etcd/pki/{{ item }}"
    owner: root
    group: root
    mode: "{{ '0600' if item == 'ca.key' else '0644' }}"
  loop:
    - ca.key
    - ca.crt

# --- Helper: SAN config file per node ---
- name: Write OpenSSL SAN config (peer/server)
  ansible.builtin.copy:
    dest: /etc/etcd/pki/openssl-san.cnf
    owner: root
    group: root
    mode: "0600"
    content: |
      [ req ]
      distinguished_name = req_distinguished_name
      req_extensions = v3_req
      prompt = no

      [ req_distinguished_name ]
      CN = {{ inventory_hostname }}

      [ v3_req ]
      keyUsage = critical, digitalSignature, keyEncipherment
      extendedKeyUsage = serverAuth, clientAuth
      subjectAltName = @alt_names

      [ alt_names ]
      DNS.1 = {{ inventory_hostname }}
      DNS.2 = {{ inventory_hostname_short }}
      IP.1 = {{ etcd_bind_ip }}
      IP.2 = 127.0.0.1

# --- Peer cert ---
- name: Generate peer key
  ansible.builtin.command: openssl genrsa -out /etc/etcd/pki/peer.key 2048
  args:
    creates: /etc/etcd/pki/peer.key

- name: Generate peer CSR
  ansible.builtin.command: >
    openssl req -new
    -key /etc/etcd/pki/peer.key
    -out /etc/etcd/pki/peer.csr
    -config /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/peer.csr

- name: Sign peer cert with CA
  ansible.builtin.command: >
    openssl x509 -req
    -in /etc/etcd/pki/peer.csr
    -CA /etc/etcd/pki/ca.crt
    -CAkey /etc/etcd/pki/ca.key
    -CAcreateserial
    -out /etc/etcd/pki/peer.crt
    -days 3650
    -extensions v3_req
    -extfile /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/peer.crt

# --- Server cert (client endpoint) ---
- name: Generate server key
  ansible.builtin.command: openssl genrsa -out /etc/etcd/pki/server.key 2048
  args:
    creates: /etc/etcd/pki/server.key

- name: Generate server CSR
  ansible.builtin.command: >
    openssl req -new
    -key /etc/etcd/pki/server.key
    -out /etc/etcd/pki/server.csr
    -config /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/server.csr

- name: Sign server cert with CA
  ansible.builtin.command: >
    openssl x509 -req
    -in /etc/etcd/pki/server.csr
    -CA /etc/etcd/pki/ca.crt
    -CAkey /etc/etcd/pki/ca.key
    -CAcreateserial
    -out /etc/etcd/pki/server.crt
    -days 3650
    -extensions v3_req
    -extfile /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/server.crt

- name: Set PKI file permissions
  ansible.builtin.file:
    path: "/etc/etcd/pki/{{ item.path }}"
    owner: root
    group: root
    mode: "{{ item.mode }}"
  loop:
    - { path: "ca.crt", mode: "0644" }
    - { path: "peer.crt", mode: "0644" }
    - { path: "server.crt", mode: "0644" }
    - { path: "ca.key", mode: "0600" }
    - { path: "peer.key", mode: "0600" }
    - { path: "server.key", mode: "0600" }
