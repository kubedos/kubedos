---
- name: Validate inventory groups
  assert:
    that:
      - (groups['control_plane'] | length) > 0
    fail_msg: "Inventory must have a [control_plane] group."

- name: Set effective Kubernetes IPs (defaults to each node's default route address)
  set_fact:
    k8s_node_ip: "{{ k8s_node_ip | default(ansible_default_ipv4.address) }}"
    k8s_api_endpoint: >-
      {{
        (k8s_api_endpoint | default(''))
        if (k8s_api_endpoint is defined and (k8s_api_endpoint | length) > 0)
        else
        (
          hostvars[groups['lb'][0]].k8s_node_ip
          | default(hostvars[groups['lb'][0]].ansible_default_ipv4.address)
        )
        if (groups['lb'] is defined and (groups['lb'] | length) > 0)
        else k8s_node_ip
      }}
  changed_when: false

- name: Render kubeadm init config
  template:
    src: kubeadm-config.yaml.j2
    dest: /etc/kubernetes/kubeadm-config.yaml
    mode: "0644"

- name: Check if control-plane already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: _adminconf

- name: Initialize Kubernetes control-plane (kubeadm init)
  command: kubeadm init --config=/etc/kubernetes/kubeadm-config.yaml --upload-certs
  when: not _adminconf.stat.exists
  register: _kubeadm_init
  changed_when: true

- name: Ensure kubelet is enabled (kubeadm will start it)
  service:
    name: kubelet
    enabled: true
  changed_when: false

- name: Configure kubectl for root
  when: _adminconf.stat.exists or (_kubeadm_init is defined and _kubeadm_init.rc == 0)
  block:
    - file:
        path: /root/.kube
        state: directory
        mode: "0700"
    - copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true
        mode: "0600"

- name: Create join command for workers
  command: kubeadm token create --print-join-command
  register: _join_worker
  changed_when: false

- name: Extract certificate key for control-plane join
  shell: "kubeadm init phase upload-certs --upload-certs | tail -n 1"
  register: _cert_key
  changed_when: false

- name: Publish join commands as facts (used by join roles)
  set_fact:
    join_command_worker: "{{ _join_worker.stdout }} --cri-socket unix:///run/containerd/containerd.sock"
    join_command_cp: "{{ _join_worker.stdout }} --control-plane --certificate-key {{ _cert_key.stdout }} --cri-socket unix:///run/containerd/containerd.sock"
  changed_when: false
