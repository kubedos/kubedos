---
- name: Sanity-check required vars
  ansible.builtin.assert:
    that:
      - k8s_api_endpoint is defined
      - k8s_node_ip is defined
      - k8s_pod_cidr is defined
      - k8s_svc_cidr is defined
      - etcd_endpoints is defined
    fail_msg: >
      Missing required vars. Need: k8s_api_endpoint, k8s_node_ip, k8s_pod_cidr, k8s_svc_cidr, etcd_endpoints

- name: Render kubeadm init config (external etcd)
  ansible.builtin.template:
    src: kubeadm-config.yaml.j2
    dest: /etc/kubernetes/kubeadm-config.yaml
    mode: "0600"

- name: kubeadm init (first control-plane)
  ansible.builtin.command: >
    kubeadm init
    --config /etc/kubernetes/kubeadm-config.yaml
    --upload-certs
    {% if cilium_kube_proxy_replacement | default(false) %}--skip-phases=addon/kube-proxy{% endif %}
  args:
    creates: /etc/kubernetes/admin.conf

- name: Setup kubeconfig dir for root
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: "0700"

- name: Copy admin kubeconfig for root (kubectl convenience)
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: true
    mode: "0600"

- name: Wait for apiserver to respond (super-admin)
  ansible.builtin.command: >
    kubectl
    --kubeconfig=/etc/kubernetes/super-admin.conf
    get --raw=/readyz
  register: readyz
  retries: 30
  delay: 2
  until: readyz.rc == 0

- name: Generate worker join command (super-admin)
  ansible.builtin.command: kubeadm token create --print-join-command
  environment:
    KUBECONFIG: /etc/kubernetes/super-admin.conf
  register: join_worker

- name: Upload control-plane certs and get cert key (super-admin)
  ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
  environment:
    KUBECONFIG: /etc/kubernetes/super-admin.conf
  register: cert_upload

- name: Extract cert key from upload output
  ansible.builtin.set_fact:
    cert_key: >-
      {{
        (cert_upload.stdout_lines
          | select('match','^[0-9a-f]{64}$')
          | list
          | first) | default('')
      }}

- name: Fail if cert_key could not be extracted
  ansible.builtin.assert:
    that:
      - cert_key | length == 64
    fail_msg: "Could not extract 64-hex certificate key from kubeadm upload-certs output."

- name: Generate base join command for control-plane (super-admin)
  ansible.builtin.command: kubeadm token create --print-join-command
  environment:
    KUBECONFIG: /etc/kubernetes/super-admin.conf
  register: join_cp_base

- name: Ensure controller artifacts directory exists
  ansible.builtin.file:
    path: /srv/ansible/artifacts
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

- name: Write join scripts to controller artifacts directory
  ansible.builtin.copy:
    dest: "/srv/ansible/artifacts/{{ item.name }}"
    mode: "0700"
    content: "{{ item.content }}"
  delegate_to: localhost
  run_once: true
  loop:
    - name: join_worker.sh
      content: |
        #!/usr/bin/env bash
        set -euo pipefail
        {{ hostvars[inventory_hostname].join_worker.stdout }} --node-name "${HOSTNAME}"

    - name: join_cp.sh
      content: |
        #!/usr/bin/env bash
        set -euo pipefail
        {{ hostvars[inventory_hostname].join_cp_base.stdout }} \
          --control-plane \
          --certificate-key {{ hostvars[inventory_hostname].cert_key }} \
          --node-name "${HOSTNAME}" \
          --apiserver-advertise-address "{{ k8s_node_ip }}"

