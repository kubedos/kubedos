---
# roles/kubeadm_init/tasks/main.yml
#
# Bootstrap kubeadm on the first control-plane node.
# Safe to re-run: kubeadm init is skipped once /etc/kubernetes/admin.conf exists.

- name: Validate inventory groups (cp/control_plane + etcd)
  ansible.builtin.assert:
    that:
      - (groups['cp'] | default([]) | length) > 0 or (groups['control_plane'] | default([]) | length) > 0
      - (groups['etcd'] | default([]) | length) > 0
    fail_msg: >-
      Inventory must define [etcd] and either [cp] or [control_plane].

- name: Set effective Kubernetes IPs
  ansible.builtin.set_fact:
    # Node IP used for advertiseAddress + kubelet node-ip.
    k8s_node_ip: "{{ k8s_node_ip | default(k8s_node_ip_default | default(ansible_default_ipv4.address)) }}"
    # API endpoint (VIP) used for controlPlaneEndpoint in kubeadm config.
    # Order: explicit var → first LB node IP → this node IP.
    k8s_api_endpoint: >-
      {{
        (k8s_api_endpoint | default(''))
        if (k8s_api_endpoint is defined and (k8s_api_endpoint | length) > 0)
        else
        (
          hostvars[groups['lb'][0]].k8s_node_ip
          | default(hostvars[groups['lb'][0]].ansible_default_ipv4.address)
        )
        if (groups['lb'] is defined and (groups['lb'] | length) > 0)
        else k8s_node_ip
      }}
  changed_when: false

- name: Render kubeadm init config
  ansible.builtin.template:
    src: kubeadm-config.yaml.j2
    dest: /etc/kubernetes/kubeadm-config.yaml
    mode: "0644"

- name: Check if control-plane already initialized
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: _adminconf

- name: Initialize Kubernetes control-plane (kubeadm init)
  ansible.builtin.command: kubeadm init --config=/etc/kubernetes/kubeadm-config.yaml --upload-certs
  when: not _adminconf.stat.exists
  register: _kubeadm_init
  changed_when: true

- name: Ensure kubelet is enabled (kubeadm will start it)
  ansible.builtin.service:
    name: kubelet
    enabled: true
  changed_when: false

- name: Configure kubectl for root
  when: _adminconf.stat.exists or (_kubeadm_init is defined and _kubeadm_init.rc == 0)
  block:
    - name: Ensure /root/.kube exists
      ansible.builtin.file:
        path: /root/.kube
        state: directory
        mode: "0700"

    - name: Copy admin kubeconfig into place
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true
        mode: "0600"

- name: Create join base command (token) for nodes
  ansible.builtin.command: kubeadm token create --print-join-command
  register: _join_base
  changed_when: false
  when: _adminconf.stat.exists or (_kubeadm_init is defined and _kubeadm_init.rc == 0)

- name: Upload certs and capture certificate key (for control-plane join)
  ansible.builtin.shell: |
    set -euo pipefail
    kubeadm init phase upload-certs --upload-certs | tail -n 1
  args:
    executable: /bin/bash
  register: _cert_key
  changed_when: false
  when: _adminconf.stat.exists or (_kubeadm_init is defined and _kubeadm_init.rc == 0)

- name: Publish kubeadm join facts (consumed by join roles)
  ansible.builtin.set_fact:
    kubeadm_cert_key: "{{ _cert_key.stdout | trim }}"
    kubeadm_join_worker_cmd: "{{ _join_base.stdout | trim }} --cri-socket unix:///run/containerd/containerd.sock"
    kubeadm_join_cp_cmd: "{{ _join_base.stdout | trim }} --control-plane --certificate-key {{ _cert_key.stdout | trim }} --cri-socket unix:///run/containerd/containerd.sock"
  changed_when: false
  when: _adminconf.stat.exists or (_kubeadm_init is defined and _kubeadm_init.rc == 0)

