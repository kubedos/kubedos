- name: Ensure provisioning directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /etc/grafana/provisioning/datasources
    - /etc/grafana/provisioning/dashboards
    - /var/lib/grafana/dashboards

- name: Configure Prometheus datasource
  copy:
    dest: /etc/grafana/provisioning/datasources/prometheus.yml
    mode: "0644"
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://10.78.0.2:9090
          isDefault: true

- name: Configure dashboard provider
  copy:
    dest: /etc/grafana/provisioning/dashboards/default.yml
    mode: "0644"
    content: |
      apiVersion: 1
      providers:
        - name: default
          orgId: 1
          folder: "Default"
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards

- name: Restart grafana
  service:
    name: grafana-server
    state: restarted
    enabled: true
