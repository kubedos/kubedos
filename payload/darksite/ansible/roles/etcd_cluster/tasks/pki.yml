---
# etcd PKI (OpenSSL, deterministic)
# Goal: etcd runs as User=etcd, so certs/keys MUST be readable by etcd.
# Root cause of your original failure:
#   /etc/etcd/pki was created 0700 root:root (not traversable by etcd),
#   causing "open /etc/etcd/pki/peer.crt: permission denied"
#
# This file:
# - Ensures /etc/etcd/pki is root:etcd 0750 (traversable by etcd)
# - Ensures private keys are etcd:etcd 0600
# - Ensures certs/CA cert are root:etcd 0644
# - Keeps ca.key root-only 0600

- name: Compute etcd bind IP (reuse existing, else etcd_ip, else default route)
  set_fact:
    etcd_bind_ip: >-
      {{
        etcd_bind_ip
          | default(etcd_ip, true)
          | default(ansible_default_ipv4.address, true)
      }}

- name: Assert etcd_bind_ip is set
  assert:
    that:
      - etcd_bind_ip is defined
      - etcd_bind_ip | length > 0
    fail_msg: "etcd_bind_ip is not set and could not be derived (etcd_ip / ansible_default_ipv4.address missing)."

- name: Ensure openssl is present
  apt:
    name: openssl
    state: present
    update_cache: false

# Controller artifacts live in artifacts/etcd-pki.
# This role signs CSRs on the node, so it copies CA key+cert onto the node.
# If you want to avoid distributing ca.key, refactor signing to be done on controller.
- name: Ensure controller CA artifact directory exists
  file:
    path: "{{ etcd_pki_controller_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  run_once: true

- name: Generate CA key on controller (if missing)
  command: "openssl genrsa -out {{ etcd_pki_controller_dir }}/ca.key 4096"
  args:
    creates: "{{ etcd_pki_controller_dir }}/ca.key"
  delegate_to: localhost
  run_once: true

- name: Generate CA cert on controller (if missing)
  command: >
    openssl req -x509 -new -nodes
    -key {{ etcd_pki_controller_dir }}/ca.key
    -sha256 -days {{ etcd_pki_ca_days }}
    -subj "/CN={{ etcd_pki_ca_cn }}"
    -out {{ etcd_pki_controller_dir }}/ca.crt
  args:
    creates: "{{ etcd_pki_controller_dir }}/ca.crt"
  delegate_to: localhost
  run_once: true

- name: Verify controller CA key matches controller CA cert
  shell: |
    set -euo pipefail
    openssl x509 -noout -modulus -in "{{ etcd_pki_controller_dir }}/ca.crt" | openssl md5
    openssl rsa  -noout -modulus -in "{{ etcd_pki_controller_dir }}/ca.key" | openssl md5
  args:
    executable: /bin/bash
  changed_when: false
  delegate_to: localhost
  run_once: true

# CRITICAL: etcd runs as User=etcd, so /etc/etcd/pki must be traversable by etcd.
- name: Ensure etcd PKI dir exists on node (readable by etcd)
  file:
    path: "{{ etcd_pki_dir }}"
    state: directory
    owner: root
    group: etcd
    mode: "0750"

- name: Install CA key/cert from controller artifacts (authoritative)
  copy:
    src: "{{ etcd_pki_controller_dir }}/{{ item.src }}"
    dest: "{{ etcd_pki_dir }}/{{ item.dest }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "ca.key", dest: "ca.key", owner: "root", group: "root", mode: "0600" }
    - { src: "ca.crt", dest: "ca.crt", owner: "root", group: "etcd", mode: "0644" }

- name: Write OpenSSL SAN config
  template:
    src: openssl_san.cnf.j2
    dest: "{{ etcd_pki_dir }}/openssl_san.cnf"
    owner: root
    group: root
    mode: "0644"

- name: Generate peer key (if missing)
  command: "openssl genrsa -out {{ etcd_pki_dir }}/peer.key 2048"
  args:
    creates: "{{ etcd_pki_dir }}/peer.key"

- name: Generate peer CSR (if missing)
  command: >
    openssl req -new
    -key {{ etcd_pki_dir }}/peer.key
    -subj "/CN={{ inventory_hostname }}"
    -out {{ etcd_pki_dir }}/peer.csr
    -config {{ etcd_pki_dir }}/openssl_san.cnf
  args:
    creates: "{{ etcd_pki_dir }}/peer.csr"

- name: Sign peer cert with CA (if missing)
  command: >
    openssl x509 -req
    -in {{ etcd_pki_dir }}/peer.csr
    -CA {{ etcd_pki_dir }}/ca.crt
    -CAkey {{ etcd_pki_dir }}/ca.key
    -CAcreateserial
    -out {{ etcd_pki_dir }}/peer.crt
    -days {{ etcd_pki_node_days }}
    -sha256
    -extensions v3_req
    -extfile {{ etcd_pki_dir }}/openssl_san.cnf
  args:
    creates: "{{ etcd_pki_dir }}/peer.crt"

- name: Generate server key (if missing)
  command: "openssl genrsa -out {{ etcd_pki_dir }}/server.key 2048"
  args:
    creates: "{{ etcd_pki_dir }}/server.key"

- name: Generate server CSR (if missing)
  command: >
    openssl req -new
    -key {{ etcd_pki_dir }}/server.key
    -subj "/CN={{ inventory_hostname }}"
    -out {{ etcd_pki_dir }}/server.csr
    -config {{ etcd_pki_dir }}/openssl_san.cnf
  args:
    creates: "{{ etcd_pki_dir }}/server.csr"

- name: Sign server cert with CA (if missing)
  command: >
    openssl x509 -req
    -in {{ etcd_pki_dir }}/server.csr
    -CA {{ etcd_pki_dir }}/ca.crt
    -CAkey {{ etcd_pki_dir }}/ca.key
    -CAcreateserial
    -out {{ etcd_pki_dir }}/server.crt
    -days {{ etcd_pki_node_days }}
    -sha256
    -extensions v3_req
    -extfile {{ etcd_pki_dir }}/openssl_san.cnf
  args:
    creates: "{{ etcd_pki_dir }}/server.crt"

- name: Set PKI file ownership + permissions for etcd runtime (authoritative)
  file:
    path: "{{ etcd_pki_dir }}/{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    # keys must be readable by the etcd daemon user
    - { path: "peer.key",   owner: "etcd", group: "etcd", mode: "0600" }
    - { path: "server.key", owner: "etcd", group: "etcd", mode: "0600" }

    # certs must be readable by etcd
    - { path: "peer.crt",   owner: "root", group: "etcd", mode: "0644" }
    - { path: "server.crt", owner: "root", group: "etcd", mode: "0644" }
    - { path: "ca.crt",     owner: "root", group: "etcd", mode: "0644" }

    # CA key root-only
    - { path: "ca.key",     owner: "root", group: "root", mode: "0600" }

- name: Ensure etcd can traverse PKI directory (defense in depth)
  file:
    path: "{{ etcd_pki_dir }}"
    owner: root
    group: etcd
    mode: "0750"

