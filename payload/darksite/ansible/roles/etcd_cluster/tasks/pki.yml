---
# Build/Install PKI on each etcd node.
# This file is intentionally defensive about variable availability.

- name: Compute etcd bind IP (reuse existing, else etcd_ip, else default route)
  ansible.builtin.set_fact:
    etcd_bind_ip: >-
      {{
        etcd_bind_ip
          | default(etcd_ip, true)
          | default(cluster_underlay_ip, true)
          | default(ansible_default_ipv4.address, true)
      }}

- name: Assert etcd_bind_ip is set
  ansible.builtin.assert:
    that:
      - etcd_bind_ip is defined
      - etcd_bind_ip | length > 0
    fail_msg: "Unable to determine etcd_bind_ip (set etcd_ip or ensure facts/default route exist)."

- name: Ensure openssl is present
  ansible.builtin.package:
    name: openssl
    state: present

# --- Controller-side CA artifacts directory ---
- name: Ensure controller CA artifact directory exists
  ansible.builtin.file:
    path: "{{ etcd_pki_controller_dir }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

# --- Ensure CA exists on controller (one CA for the cluster) ---
- name: Generate CA key if missing
  ansible.builtin.command: >
    openssl genrsa -out {{ etcd_pki_controller_dir }}/ca.key 4096
  args:
    creates: "{{ etcd_pki_controller_dir }}/ca.key"
  delegate_to: localhost
  run_once: true

- name: Generate CA cert if missing
  ansible.builtin.command: >
    openssl req -x509 -new -nodes
    -key {{ etcd_pki_controller_dir }}/ca.key
    -sha256 -days 3650
    -subj "/CN=etcd-ca"
    -out {{ etcd_pki_controller_dir }}/ca.crt
  args:
    creates: "{{ etcd_pki_controller_dir }}/ca.crt"
  delegate_to: localhost
  run_once: true

# --- Node-side PKI directory ---
- name: Ensure etcd PKI dir exists on node
  ansible.builtin.file:
    path: "{{ etcd_pki_dir }}"
    state: directory
    owner: "{{ etcd_pki_owner }}"
    group: "{{ etcd_pki_group }}"
    mode: "{{ etcd_pki_dir_mode }}"

# --- Copy CA artifacts from controller to node (role signs locally using CA key) ---
- name: Copy CA cert to node
  ansible.builtin.copy:
    src: "{{ etcd_pki_controller_dir }}/ca.crt"
    dest: "{{ etcd_pki_dir }}/ca.crt"
    owner: "{{ etcd_pki_owner }}"
    group: "{{ etcd_pki_group }}"
    mode: "{{ etcd_pki_cert_mode }}"

- name: Copy CA key to node (required for local signing in this role)
  ansible.builtin.copy:
    src: "{{ etcd_pki_controller_dir }}/ca.key"
    dest: "{{ etcd_pki_dir }}/ca.key"
    owner: "{{ etcd_pki_owner }}"
    group: "{{ etcd_pki_group }}"
    mode: "{{ etcd_pki_key_mode }}"

# --- Build SANs (keep it simple & correct for etcd peer/server) ---
- name: Build SAN list for this node
  ansible.builtin.set_fact:
    etcd_node_sans:
      - "DNS:{{ inventory_hostname }}"
      - "DNS:localhost"
      - "IP:127.0.0.1"
      - "IP:{{ etcd_bind_ip }}"

# --- Render an OpenSSL ext file for both peer and server certs ---
- name: Render node OpenSSL extension file (peer/server)
  ansible.builtin.copy:
    dest: "{{ etcd_pki_dir }}/openssl-etcd-ext.cnf"
    owner: "{{ etcd_pki_owner }}"
    group: "{{ etcd_pki_group }}"
    mode: "0644"
    content: |
      [ req ]
      distinguished_name = req_distinguished_name
      req_extensions = v3_req
      prompt = no

      [ req_distinguished_name ]
      CN = {{ inventory_hostname }}

      [ v3_req ]
      keyUsage = critical, digitalSignature, keyEncipherment
      extendedKeyUsage = serverAuth, clientAuth
      subjectAltName = {{ etcd_node_sans | join(',') }}

# --- Peer cert/key ---
- name: Generate peer private key if missing
  ansible.builtin.command: >
    openssl genrsa -out {{ etcd_pki_dir }}/peer.key 2048
  args:
    creates: "{{ etcd_pki_dir }}/peer.key"

- name: Generate peer CSR if missing
  ansible.builtin.command: >
    openssl req -new
    -key {{ etcd_pki_dir }}/peer.key
    -out {{ etcd_pki_dir }}/peer.csr
    -config {{ etcd_pki_dir }}/openssl-etcd-ext.cnf
  args:
    creates: "{{ etcd_pki_dir }}/peer.csr"

- name: Sign peer cert with CA if missing
  ansible.builtin.command: >
    openssl x509 -req
    -in {{ etcd_pki_dir }}/peer.csr
    -CA {{ etcd_pki_dir }}/ca.crt
    -CAkey {{ etcd_pki_dir }}/ca.key
    -CAcreateserial
    -out {{ etcd_pki_dir }}/peer.crt
    -days 3650 -sha256
    -extensions v3_req
    -extfile {{ etcd_pki_dir }}/openssl-etcd-ext.cnf
  args:
    creates: "{{ etcd_pki_dir }}/peer.crt"

# --- Server cert/key ---
- name: Generate server private key if missing
  ansible.builtin.command: >
    openssl genrsa -out {{ etcd_pki_dir }}/server.key 2048
  args:
    creates: "{{ etcd_pki_dir }}/server.key"

- name: Generate server CSR if missing
  ansible.builtin.command: >
    openssl req -new
    -key {{ etcd_pki_dir }}/server.key
    -out {{ etcd_pki_dir }}/server.csr
    -config {{ etcd_pki_dir }}/openssl-etcd-ext.cnf
  args:
    creates: "{{ etcd_pki_dir }}/server.csr"

- name: Sign server cert with CA if missing
  ansible.builtin.command: >
    openssl x509 -req
    -in {{ etcd_pki_dir }}/server.csr
    -CA {{ etcd_pki_dir }}/ca.crt
    -CAkey {{ etcd_pki_dir }}/ca.key
    -CAcreateserial
    -out {{ etcd_pki_dir }}/server.crt
    -days 3650 -sha256
    -extensions v3_req
    -extfile {{ etcd_pki_dir }}/openssl-etcd-ext.cnf
  args:
    creates: "{{ etcd_pki_dir }}/server.crt"

# --- Permissions: make sure User=etcd can read ---
- name: Tighten permissions on generated private keys and certs
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ etcd_pki_owner }}"
    group: "{{ etcd_pki_group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ etcd_pki_dir }}/ca.key",     mode: "{{ etcd_pki_key_mode }}" }
    - { path: "{{ etcd_pki_dir }}/peer.key",   mode: "{{ etcd_pki_key_mode }}" }
    - { path: "{{ etcd_pki_dir }}/server.key", mode: "{{ etcd_pki_key_mode }}" }
    - { path: "{{ etcd_pki_dir }}/ca.crt",     mode: "{{ etcd_pki_cert_mode }}" }
    - { path: "{{ etcd_pki_dir }}/peer.crt",   mode: "{{ etcd_pki_cert_mode }}" }
    - { path: "{{ etcd_pki_dir }}/server.crt", mode: "{{ etcd_pki_cert_mode }}" }

