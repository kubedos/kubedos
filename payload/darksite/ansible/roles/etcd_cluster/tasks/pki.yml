---
# etcd PKI (OpenSSL, deterministic)
# - CA is generated ONCE on the controller (localhost) and distributed to all nodes.
# - Per-node peer + server certs include SANs for:
#   - etcd_bind_ip (etcd_ip preferred, then cluster_underlay_ip if defined, then ansible_host, then default route IP)
#   - 127.0.0.1
#   - inventory hostname + shortname

- name: Compute etcd bind IP (must match SANs + etcd.conf.yml)
  ansible.builtin.set_fact:
    etcd_bind_ip: >-
      {{
        (
          [
            (etcd_ip | default('')),
            ((cluster_underlay_ip | default('')) if (cluster_underlay_ip is defined) else ''),
            (ansible_host | default('')),
            ((ansible_default_ipv4.address | default('')) if (ansible_default_ipv4 is defined) else '')
          ]
          | map('string')
          | map('trim')
          | select('match', '.+')
          | list
        )[0]
      }}

- name: Assert etcd_bind_ip is set
  ansible.builtin.assert:
    that:
      - (etcd_bind_ip | string | trim) != ""
    fail_msg: >-
      etcd_bind_ip is empty. Define etcd_ip per host (recommended),
      or define cluster_underlay_ip, or ensure ansible_host is set.

- name: Ensure openssl is present
  ansible.builtin.package:
    name: openssl
    state: present

# ------------------------------------------------------------------------------
# CA generation on controller (single source of truth)
# ------------------------------------------------------------------------------
- name: Ensure controller CA artifact directory exists
  ansible.builtin.file:
    path: /srv/ansible/artifacts/etcd-pki
    state: directory
    mode: "0700"
  delegate_to: localhost
  run_once: true

- name: Generate CA key on controller (if missing)
  ansible.builtin.command: openssl genrsa -out /srv/ansible/artifacts/etcd-pki/ca.key 4096
  args:
    creates: /srv/ansible/artifacts/etcd-pki/ca.key
  delegate_to: localhost
  run_once: true

- name: Generate CA cert on controller (if missing)
  ansible.builtin.command: >
    openssl req -x509 -new -nodes
    -key /srv/ansible/artifacts/etcd-pki/ca.key
    -subj "/CN=etcd-ca"
    -days 3650
    -out /srv/ansible/artifacts/etcd-pki/ca.crt
  args:
    creates: /srv/ansible/artifacts/etcd-pki/ca.crt
  delegate_to: localhost
  run_once: true

- name: Verify controller CA key matches controller CA cert
  ansible.builtin.shell: |
    set -euo pipefail
    km="$(openssl pkey -in /srv/ansible/artifacts/etcd-pki/ca.key -pubout 2>/dev/null | sha256sum | awk '{print $1}')"
    cm="$(openssl x509 -in /srv/ansible/artifacts/etcd-pki/ca.crt -pubkey -noout 2>/dev/null | sha256sum | awk '{print $1}')"
    test "$km" = "$cm"
  args:
    executable: /bin/bash
  delegate_to: localhost
  run_once: true
  changed_when: false

# ------------------------------------------------------------------------------
# Distribute CA to nodes
# ------------------------------------------------------------------------------
- name: Ensure etcd PKI dir exists on node
  ansible.builtin.file:
    path: /etc/etcd/pki
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Install CA key/cert from controller artifacts (authoritative)
  ansible.builtin.copy:
    src: "/srv/ansible/artifacts/etcd-pki/{{ item.src }}"
    dest: "/etc/etcd/pki/{{ item.dest }}"
    owner: root
    group: root
    mode: "{{ item.mode }}"
  loop:
    - { src: "ca.key", dest: "ca.key", mode: "0600" }
    - { src: "ca.crt", dest: "ca.crt", mode: "0644" }

# ------------------------------------------------------------------------------
# Per-node SAN config and leaf certs
# ------------------------------------------------------------------------------
- name: Write OpenSSL SAN config
  ansible.builtin.copy:
    dest: /etc/etcd/pki/openssl-san.cnf
    owner: root
    group: root
    mode: "0600"
    content: |
      [ req ]
      distinguished_name = req_distinguished_name
      req_extensions = v3_req
      prompt = no

      [ req_distinguished_name ]
      CN = {{ inventory_hostname }}

      [ v3_req ]
      keyUsage = critical, digitalSignature, keyEncipherment
      extendedKeyUsage = serverAuth, clientAuth
      subjectAltName = @alt_names

      [ alt_names ]
      DNS.1 = {{ inventory_hostname }}
      DNS.2 = {{ inventory_hostname_short }}
      IP.1 = {{ etcd_bind_ip }}
      IP.2 = 127.0.0.1

# --- Peer cert ---
- name: Generate peer key
  ansible.builtin.command: openssl genrsa -out /etc/etcd/pki/peer.key 2048
  args:
    creates: /etc/etcd/pki/peer.key

- name: Generate peer CSR
  ansible.builtin.command: >
    openssl req -new
    -key /etc/etcd/pki/peer.key
    -out /etc/etcd/pki/peer.csr
    -config /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/peer.csr

- name: Sign peer cert with CA
  ansible.builtin.command: >
    openssl x509 -req
    -in /etc/etcd/pki/peer.csr
    -CA /etc/etcd/pki/ca.crt
    -CAkey /etc/etcd/pki/ca.key
    -CAcreateserial
    -out /etc/etcd/pki/peer.crt
    -days 3650
    -extensions v3_req
    -extfile /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/peer.crt

# --- Server cert ---
- name: Generate server key
  ansible.builtin.command: openssl genrsa -out /etc/etcd/pki/server.key 2048
  args:
    creates: /etc/etcd/pki/server.key

- name: Generate server CSR
  ansible.builtin.command: >
    openssl req -new
    -key /etc/etcd/pki/server.key
    -out /etc/etcd/pki/server.csr
    -config /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/server.csr

- name: Sign server cert with CA
  ansible.builtin.command: >
    openssl x509 -req
    -in /etc/etcd/pki/server.csr
    -CA /etc/etcd/pki/ca.crt
    -CAkey /etc/etcd/pki/ca.key
    -CAcreateserial
    -out /etc/etcd/pki/server.crt
    -days 3650
    -extensions v3_req
    -extfile /etc/etcd/pki/openssl-san.cnf
  args:
    creates: /etc/etcd/pki/server.crt

- name: Set PKI file permissions
  ansible.builtin.file:
    path: "/etc/etcd/pki/{{ item.path }}"
    owner: root
    group: root
    mode: "{{ item.mode }}"
  loop:
    - { path: "ca.crt", mode: "0644" }
    - { path: "peer.crt", mode: "0644" }
    - { path: "server.crt", mode: "0644" }
    - { path: "ca.key", mode: "0600" }
    - { path: "peer.key", mode: "0600" }
    - { path: "server.key", mode: "0600" }
