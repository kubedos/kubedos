---
# Deploy etcd with mutual TLS (client + peer) on Debian/Ubuntu
# Assumes PKI artifacts exist on controller at /srv/ansible/artifacts/etcd-pki

- name: Install etcd server + client (Debian)
  ansible.builtin.apt:
    name:
      - etcd-server
      - etcd-client
    state: present
    update_cache: true

- name: Ensure cluster IP facts exist
  ansible.builtin.set_fact:
    cluster_underlay_ip: "{{ cluster_underlay_ip | default(ansible_default_ipv4.address) }}"
    cluster_mgmt_ip: "{{ cluster_mgmt_ip | default(ansible_host | default(ansible_default_ipv4.address)) }}"

# -----------------------------------------------------------------------------
# Directories
# -----------------------------------------------------------------------------
- name: Ensure etcd config dir exists
  ansible.builtin.file:
    path: /etc/etcd
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure etcd PKI dir exists
  ansible.builtin.file:
    path: /etc/etcd/pki
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure etcd data dir exists
  ansible.builtin.file:
    path: /var/lib/etcd
    state: directory
    owner: etcd
    group: etcd
    mode: "0700"

# -----------------------------------------------------------------------------
# PKI (read on controller, then push to nodes)
# -----------------------------------------------------------------------------
- name: Define PKI artifact paths (controller)
  ansible.builtin.set_fact:
    etcd_pki_root: /srv/ansible/artifacts/etcd-pki
    etcd_pki_common:
      - { src: "/srv/ansible/artifacts/etcd-pki/ca.crt", dest: "/etc/etcd/pki/ca.crt", mode: "0644" }
    etcd_pki_node:
      - { src: "/srv/ansible/artifacts/etcd-pki/{{ inventory_hostname }}/peer.crt",   dest: "/etc/etcd/pki/peer.crt",   mode: "0644" }
      - { src: "/srv/ansible/artifacts/etcd-pki/{{ inventory_hostname }}/peer.key",   dest: "/etc/etcd/pki/peer.key",   mode: "0640" }
      - { src: "/srv/ansible/artifacts/etcd-pki/{{ inventory_hostname }}/server.crt", dest: "/etc/etcd/pki/server.crt", mode: "0644" }
      - { src: "/srv/ansible/artifacts/etcd-pki/{{ inventory_hostname }}/server.key", dest: "/etc/etcd/pki/server.key", mode: "0640" }

- name: Assert PKI artifacts exist on controller (common)
  ansible.builtin.stat:
    path: "{{ item.src }}"
  register: _pki_common_stats
  loop: "{{ etcd_pki_common }}"
  delegate_to: localhost

- name: Assert PKI artifacts exist on controller (per-node)
  ansible.builtin.stat:
    path: "{{ item.src }}"
  register: _pki_node_stats
  loop: "{{ etcd_pki_node }}"
  delegate_to: localhost

- name: Fail if required PKI artifacts are missing on controller
  ansible.builtin.fail:
    msg: "Missing PKI artifact on controller: {{ item.item.src }}"
  when: not item.stat.exists
  loop: "{{ _pki_common_stats.results + _pki_node_stats.results }}"

# Critical change: slurp on controller, then copy via content (avoids controller-side copy src resolution)
- name: Read PKI artifacts from controller (base64)
  ansible.builtin.slurp:
    src: "{{ item.src }}"
  register: _pki_slurped
  loop: "{{ etcd_pki_common + etcd_pki_node }}"
  delegate_to: localhost

- name: Copy etcd PKI to node (from slurped content)
  ansible.builtin.copy:
    content: "{{ item.content | b64decode }}"
    dest: "{{ item.item.dest }}"
    owner: root
    group: etcd
    mode: "{{ item.item.mode }}"
  loop: "{{ _pki_slurped.results }}"

- name: Re-assert PKI exists on node
  ansible.builtin.stat:
    path: "/etc/etcd/pki/{{ item }}"
  register: _pki_on_node
  loop:
    - ca.crt
    - peer.crt
    - peer.key
    - server.crt
    - server.key

- name: Fail if PKI did not land on node
  ansible.builtin.fail:
    msg: "PKI missing on node: {{ item.item }}"
  when: not item.stat.exists
  loop: "{{ _pki_on_node.results }}"

# -----------------------------------------------------------------------------
# Config
# -----------------------------------------------------------------------------
- name: Compute initial cluster string
  ansible.builtin.set_fact:
    etcd_initial_cluster: >-
      {%- set parts = [] -%}
      {%- for h in groups['etcd'] -%}
      {%- set _ = parts.append(h ~ '=https://' ~ hostvars[h].cluster_underlay_ip ~ ':2380') -%}
      {%- endfor -%}
      {{ parts | join(',') }}

- name: Determine if etcd already initialized
  ansible.builtin.stat:
    path: /var/lib/etcd/member
  register: _etcd_member_dir

- name: Set initial cluster state
  ansible.builtin.set_fact:
    etcd_initial_cluster_state: "{{ 'existing' if _etcd_member_dir.stat.exists else 'new' }}"

- name: Render etcd config
  ansible.builtin.template:
    src: etcd.conf.yml.j2
    dest: /etc/etcd/etcd.conf.yml
    owner: root
    group: root
    mode: "0644"
  register: _etcd_cfg

- name: Render systemd unit
  ansible.builtin.template:
    src: etcd.service.j2
    dest: /etc/systemd/system/etcd.service
    owner: root
    group: root
    mode: "0644"
  register: _etcd_unit

- name: Daemon-reload if unit changed
  ansible.builtin.systemd:
    daemon_reload: true
  when: _etcd_unit.changed

- name: Remove invalid default marker file in etcd data dir (if present)
  ansible.builtin.file:
    path: /var/lib/etcd/default.etcd
    state: absent

# -----------------------------------------------------------------------------
# Start / restart
# -----------------------------------------------------------------------------
- name: Enable etcd
  ansible.builtin.systemd:
    name: etcd
    enabled: true

- name: Restart etcd if config or unit changed
  ansible.builtin.command: systemctl restart etcd
  register: _restart_out
  changed_when: true
  when: _etcd_cfg.changed or _etcd_unit.changed
  async: 600
  poll: 5

- name: Start etcd if not running
  ansible.builtin.systemd:
    name: etcd
    state: started

- name: Wait for etcd client port (2379) to be reachable
  ansible.builtin.wait_for:
    host: "{{ cluster_underlay_ip }}"
    port: 2379
    delay: 1
    timeout: 60
  delegate_to: localhost

- name: Wait for etcd peer port (2380) to be reachable
  ansible.builtin.wait_for:
    host: "{{ cluster_underlay_ip }}"
    port: 2380
    delay: 1
    timeout: 60
  delegate_to: localhost

