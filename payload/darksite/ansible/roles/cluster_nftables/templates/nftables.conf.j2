# Managed by Ansible (cluster_nftables)
# DO NOT EDIT MANUALLY

flush ruleset

{% set tcp_ports = (cluster_nftables_allowed_tcp_ports | default([])) + (cluster_nftables_extra_tcp_ports | default([])) %}
{% set udp_ports = (cluster_nftables_allowed_udp_ports | default([])) + (cluster_nftables_extra_udp_ports | default([])) %}
{% set trusted = (cluster_nftables_trusted_cidrs | default([])) %}

table inet filter {
  chain input {
    type filter hook input priority 0;
    policy {{ cluster_nftables_input_policy | default('drop') }};

    {% if cluster_nftables_allow_loopback | default(true) %}
    iif "lo" accept
    {% endif %}

    ct state established,related accept
    ct state invalid drop

    {# Allow all from trusted CIDRs if provided (IPv4 -> ip, IPv6 -> ip6) #}
    {% for cidr in trusted %}
    {%   set c = (cidr | string | trim) %}
    {%   if ':' in c %}
    ip6 saddr {{ c }} accept
    {%   else %}
    ip saddr {{ c }} accept
    {%   endif %}
    {% endfor %}

    {% if cluster_nftables_allow_icmp | default(true) %}
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept
    {% endif %}

    {% if cluster_nftables_allow_ssh | default(true) %}
    tcp dport {{ cluster_nftables_ssh_port | default(22) }} accept
    {% endif %}

    {% if tcp_ports | length > 0 %}
    tcp dport { {{ tcp_ports | map('int') | unique | sort | join(', ') }} } accept
    {% endif %}

    {% if udp_ports | length > 0 %}
    udp dport { {{ udp_ports | map('int') | unique | sort | join(', ') }} } accept
    {% endif %}

    {# Optional extra rules as raw nft lines #}
    {% for rule in (cluster_nftables_input_extra_rules | default([])) %}
    {{ rule }}
    {% endfor %}

    counter drop
  }

  chain forward {
    type filter hook forward priority 0;
    policy {{ cluster_nftables_forward_policy | default('drop') }};

    ct state established,related accept
    ct state invalid drop

    {% for rule in (cluster_nftables_forward_extra_rules | default([])) %}
    {{ rule }}
    {% endfor %}

    counter drop
  }

  chain output {
    type filter hook output priority 0;
    policy {{ cluster_nftables_output_policy | default('accept') }};

    {% for rule in (cluster_nftables_output_extra_rules | default([])) %}
    {{ rule }}
    {% endfor %}
  }
}

