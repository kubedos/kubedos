---
# Common baseline: deterministic apt + baseline packages
# NOTE: This role assumes passwordless sudo on targets (or run with -K).
# It is safe to re-run; it does not destroy state.

- name: Preflight | wait for dpkg/apt locks to clear (raw, no python3-apt dependency)
  become: true
  become_flags: "{{ ansible_become_flags | default('-H -n') }}"
  raw: |
    set -euo pipefail
    for i in $(seq 1 60); do
      if fuser /var/lib/dpkg/lock >/dev/null 2>&1; then
        sleep 2
        continue
      fi
      if fuser /var/lib/apt/lists/lock >/dev/null 2>&1; then
        sleep 2
        continue
      fi
      if fuser /var/cache/apt/archives/lock >/dev/null 2>&1; then
        sleep 2
        continue
      fi
      exit 0
    done
    echo "Timed out waiting for dpkg/apt locks" >&2
    exit 1
  changed_when: false

- name: Preflight | ensure python3-apt present (raw, lock-safe)
  become: true
  become_flags: "{{ ansible_become_flags | default('-H -n') }}"
  raw: |
    set -euo pipefail
    if python3 -c 'import apt' >/dev/null 2>&1; then
      exit 0
    fi
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y
    apt-get install -y python3-apt
  changed_when: false

- name: Disable unattended apt background services (determinism)
  become: true
  systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
    masked: true
  loop:
    - apt-daily.service
    - apt-daily.timer
    - apt-daily-upgrade.service
    - apt-daily-upgrade.timer
    - unattended-upgrades.service

- name: Apt update (baseline)
  become: true
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Ensure baseline packages (required)
  become: true
  apt:
    name: "{{ common_required_packages }}"
    state: present
    update_cache: false

- name: Ensure optional convenience package (software-properties-common)
  become: true
  apt:
    name: software-properties-common
    state: present
    update_cache: false
  register: _spc
  failed_when: false

- name: Warn if software-properties-common is unavailable
  debug:
    msg: "software-properties-common unavailable on {{ inventory_hostname }} (non-fatal)"
  when: _spc is failed

