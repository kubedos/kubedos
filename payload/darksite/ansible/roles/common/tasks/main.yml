---
# Common baseline for all nodes (etcd, control plane, workers, lb, monitoring, storage)
# This role keeps the OS ready for Kubernetes and your eBPF/WireGuard overlay model.

- name: Ensure baseline packages
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - apt-transport-https
      - software-properties-common
      - socat
      - conntrack
      - iptables
      - iproute2
      - ethtool
      - jq
      - bash-completion
    state: present
    update_cache: true

# --- Swap (Kubernetes default expectation: disabled) ---
- name: Disable swap immediately
  command: swapoff -a
  changed_when: false
  failed_when: false

- name: Remove swap entries from /etc/fstab (disable swap persistently)
  replace:
    path: /etc/fstab
    regexp: '^(\s*[^#\n]+\s+[^\s]+\s+swap\s+[^\n]+)$'
    replace: '# \1'
  failed_when: false

# --- Kernel modules required for k8s networking ---
- name: Ensure kernel modules config for Kubernetes
  copy:
    dest: /etc/modules-load.d/k8s.conf
    mode: "0644"
    content: |
      overlay
      br_netfilter

- name: Load kernel modules now
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter
  failed_when: false

# --- Sysctls required for Kubernetes (IPv4-focused; adjust if you want IPv6) ---
- name: Ensure Kubernetes sysctls are set
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: net.bridge.bridge-nf-call-iptables,  value: "1" }
    - { name: net.bridge.bridge-nf-call-ip6tables, value: "1" }
    - { name: net.ipv4.ip_forward,                value: "1" }

# --- Optional: basic firewall allowances (only if ufw is present/enabled) ---
- name: Allow kube-apiserver access from cluster subnet (control plane & lbs)
  when: inventory_hostname in groups['control_plane'] or inventory_hostname in groups['lb']
  block:
    - name: Check if ufw is installed
      command: which ufw
      register: ufw_check
      changed_when: false
      failed_when: false

    - name: Allow TCP 6443 from k8s_node_subnet (ufw)
      when: ufw_check.rc == 0
      community.general.ufw:
        rule: allow
        port: "6443"
        proto: tcp
        from_ip: "{{ k8s_node_subnet }}"
      failed_when: false

