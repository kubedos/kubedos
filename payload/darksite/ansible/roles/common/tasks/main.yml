---
# Role: common
# Baseline OS packages for kube/WG hosts.
# Key points:
# - Avoid racing cloud-init/unattended-upgrades apt by waiting for dpkg/apt locks.
# - Ensure python3-apt is installed *via raw* before using ansible.builtin.apt.
# - Keep nonessential convenience packages non-fatal.

- name: Preflight | wait for dpkg/apt locks to clear (raw, no python3-apt dependency)
  ansible.builtin.raw: |
    set -euo pipefail
    locks="/var/lib/dpkg/lock /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock"
    for i in $(seq 1 180); do
      busy=0
      for l in $locks; do
        if [ -e "$l" ] && fuser "$l" >/dev/null 2>&1; then busy=1; fi
      done
      if pgrep -x apt-get >/dev/null 2>&1 || pgrep -x apt >/dev/null 2>&1 || pgrep -x dpkg >/dev/null 2>&1; then busy=1; fi
      if [ "$busy" -eq 0 ]; then exit 0; fi
      sleep 5
    done
    echo "Timed out waiting for apt/dpkg locks/processes to clear" >&2
    pgrep -a apt-get || true
    pgrep -a apt || true
    pgrep -a dpkg || true
    exit 1
  changed_when: false

- name: Preflight | ensure python3-apt present (raw, lock-safe)
  ansible.builtin.raw: |
    set -euo pipefail
    if dpkg -s python3-apt >/dev/null 2>&1; then
      exit 0
    fi
    export DEBIAN_FRONTEND=noninteractive
    for i in $(seq 1 60); do
      apt-get -y -q \
        -o DPkg::Lock::Timeout=300 \
        -o Dpkg::Options::=--force-confdef \
        -o Dpkg::Options::=--force-confold \
        update || true

      if apt-get -y -q \
        -o DPkg::Lock::Timeout=300 \
        -o Dpkg::Options::=--force-confdef \
        -o Dpkg::Options::=--force-confold \
        install python3-apt; then
        exit 0
      fi
      sleep 5
    done
    echo "Failed to install python3-apt after retries" >&2
    exit 1
  changed_when: false

# Determinism: prevent background apt timers from interfering mid-run.
- name: Disable unattended apt background services (determinism)
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
    masked: true
  loop:
    - apt-daily.service
    - apt-daily.timer
    - apt-daily-upgrade.service
    - apt-daily-upgrade.timer
    - unattended-upgrades.service
  failed_when: false

- name: Apt update (baseline)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
    lock_timeout: 300

- name: Ensure baseline packages (required)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - apt-transport-https
      - lsb-release
      - jq
      - iproute2
      - iptables
      - ethtool
      - conntrack
      - socat
      - ebtables
      - chrony
    state: present
    update_cache: false
    lock_timeout: 300

- name: Ensure optional convenience package (software-properties-common)
  ansible.builtin.apt:
    name:
      - software-properties-common
    state: present
    update_cache: false
    lock_timeout: 300
  register: _softprops
  failed_when: false

- name: Warn if software-properties-common is unavailable
  ansible.builtin.debug:
    msg: >-
      WARNING: software-properties-common could not be installed on {{ inventory_hostname }}.
      This is non-fatal. If you rely on add-apt-repository, fix apt sources on that node.
      apt msg: {{ _softprops.msg | default('unknown') }}
  when: _softprops is failed
