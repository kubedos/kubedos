---
# roles/kubeadm_join_cp/tasks/main.yml
#
# Joins additional control-plane nodes using kubeadm join facts published by the bootstrap control-plane.

- name: Set effective Kubernetes node IP
  ansible.builtin.set_fact:
    k8s_node_ip: "{{ k8s_node_ip | default(k8s_node_ip_default | default(ansible_default_ipv4.address)) }}"
  changed_when: false

- name: Select bootstrap control-plane host
  ansible.builtin.set_fact:
    cp_bootstrap: "{{ (groups['cp'] | default([]) + groups['control_plane'] | default([])) | first }}"
  changed_when: false

- name: Assert bootstrap join facts exist
  ansible.builtin.assert:
    that:
      - cp_bootstrap is defined
      - cp_bootstrap | length > 0
      - hostvars[cp_bootstrap].kubeadm_join_cp_cmd is defined
    fail_msg: >-
      Missing kubeadm join facts. Ensure kubeadm_init ran on the bootstrap CP and published kubeadm_join_cp_cmd.

- name: Join control-plane to cluster (per-host advertise IP)
  ansible.builtin.shell: >
    {{ hostvars[cp_bootstrap].kubeadm_join_cp_cmd }}
    --node-name {{ inventory_hostname }}
    --apiserver-advertise-address {{ k8s_node_ip }}
  args:
    creates: /etc/kubernetes/admin.conf
    executable: /bin/bash

