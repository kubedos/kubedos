---
- name: Set fact-host (single source of truth host for run_once facts)
  set_fact:
    k8s_fact_host: "{{ ansible_play_hosts_all[0] }}"

# Kubernetes should bind to the default IPv4 address unless explicitly overridden.
# You can still set per-host k8s_node_ip in inventory/host_vars if you want to force
# it to a specific interface/IP (e.g. a dedicated backplane), but by default we use
# ansible_default_ipv4.address (your public/primary node IP).
- name: Set effective k8s node IP (defaults to ansible_default_ipv4.address)
  set_fact:
    k8s_node_ip_effective: "{{ (k8s_node_ip | default(ansible_default_ipv4.address, true)) | trim }}"

- name: Sanity check effective k8s node IP
  assert:
    that:
      - (k8s_node_ip_effective | default('') | trim) != ""
    fail_msg: "Unable to determine k8s_node_ip_effective (k8s_node_ip not set and ansible_default_ipv4.address missing)."

# canonical fact used by downstream roles
- name: Set canonical k8s_node_ip fact
  set_fact:
    k8s_node_ip: "{{ k8s_node_ip_effective }}"

- name: Install Kubernetes packages and dependencies
  include_tasks: pkgs.yml
