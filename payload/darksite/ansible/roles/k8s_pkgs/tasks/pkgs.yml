---
# roles/k8s_pkgs/tasks/pkgs.yml
#
# Installs kubelet/kubeadm/kubectl from the official Kubernetes apt repo.
# Works on Debian 12/13 and avoids deprecated packages like software-properties-common.

- name: Ensure base dependencies are present
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gpg
      - apt-transport-https
      - lsb-release
      - gnupg
    state: present
    update_cache: true

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Compute Kubernetes minor repo (v1.xx)
  ansible.builtin.set_fact:
    _k8s_minor_repo_effective: >-
      {{
        (k8s_minor_repo | default('', true) | trim)
        if (k8s_minor_repo | default('', true) | trim) != ''
        else (k8s_full_version | default('v1.31.14') | regex_replace('^(v[0-9]+\\.[0-9]+).*$', '\\1'))
      }}

- name: Install Kubernetes apt repo key (pkgs.k8s.io)
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL https://pkgs.k8s.io/core:/stable:/{{ _k8s_minor_repo_effective }}/deb/Release.key \
      | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes apt repository (pkgs.k8s.io)
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg]
      https://pkgs.k8s.io/core:/stable:/{{ _k8s_minor_repo_effective }}/deb/
      /
    filename: kubernetes
    state: present

- name: Update apt cache after adding Kubernetes repo
  ansible.builtin.apt:
    update_cache: true

- name: Install kubelet/kubeadm/kubectl
  ansible.builtin.apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present

- name: Hold Kubernetes packages (prevent unintended upgrades)
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

