---
- name: Kubernetes repo bootstrap + version manifest (deb pins)
  hosts: "cp-*:w-*"
  gather_facts: false
  become: true
  any_errors_fatal: true

  vars:
    # Pin the Kubernetes repo minor intentionally
    k8s_minor_repo: "v1.35"

    # Repo URL
    k8s_repo_url: "https://pkgs.k8s.io/core:/stable:/{{ k8s_minor_repo }}/deb/"

    # Where to write the pinned versions (on controller)
    manifest_path: "/srv/ansible/group_vars/all/k8s_versions.yml"

    # Patterns that indicate apt repo trust/DNS/TLS failures
    fail_patterns:
      - "NO_PUBKEY"
      - "EXPKEYSIG"
      - "signatures were invalid"
      - "is not signed"
      - "Could not resolve"
      - "Temporary failure resolving"
      - "TLS"
      - "Handshake"

  tasks:
    - name: Ensure baseline tooling for repo bootstrap
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - apt-transport-https
        state: present
        update_cache: true
      check_mode: no

    - name: Ensure apt keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"
      check_mode: no

    - name: Fetch Kubernetes repo Release.key
      ansible.builtin.get_url:
        url: "{{ k8s_repo_url }}Release.key"
        dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
        mode: "0644"
      check_mode: no

    - name: Dearmor Kubernetes key into keyring
      ansible.builtin.command: >
        gpg --batch --yes --dearmor
        -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        /etc/apt/keyrings/kubernetes-apt-keyring.asc
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      check_mode: no

    - name: Install Kubernetes apt source list
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        mode: "0644"
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] {{ k8s_repo_url }} /
      check_mode: no

    - name: Apt update (capture output)
      ansible.builtin.shell: |
        set -euo pipefail
        apt-get update 2>&1 | tee /tmp/apt-update.k8s.log
      args:
        executable: /bin/bash
      register: apt_update_out
      changed_when: false
      check_mode: no

    - name: Fail loudly if Kubernetes repo is not usable (trust/DNS/TLS)
      ansible.builtin.fail:
        msg: |
          Kubernetes apt repo is not usable on {{ inventory_hostname }}.
          Repo: {{ k8s_repo_url }}

          Filtered apt-get update output:
          {{ (apt_update_out.stdout_lines
              | select('match', '.*(pkgs\\.k8s\\.io|NO_PUBKEY|EXPKEYSIG|not signed|signatures were invalid|Could not resolve|Temporary failure resolving|TLS|Handshake).*')
              | list) | join('\n') }}

          Full log on node: /tmp/apt-update.k8s.log
      when: >
        (fail_patterns | select('in', apt_update_out.stdout) | list | length) > 0

    - name: Resolve newest deb versions from apt (run once)
      ansible.builtin.shell: |
        set -euo pipefail
        pick() {
          local p="$1"
          apt-cache madison "$p" | awk '{print $3}' | LC_ALL=C sort -Vu | tail -n1
        }
        kubelet="$(pick kubelet || true)"
        kubeadm="$(pick kubeadm || true)"
        kubectl="$(pick kubectl || true)"

        if [ -z "${kubelet}" ] || [ -z "${kubeadm}" ] || [ -z "${kubectl}" ]; then
          echo "ERROR: one or more packages not present in apt."
          echo "kubelet='${kubelet}' kubeadm='${kubeadm}' kubectl='${kubectl}'"
          exit 1
        fi

        echo "kubelet=${kubelet}"
        echo "kubeadm=${kubeadm}"
        echo "kubectl=${kubectl}"
        echo "semver=${kubelet%%-*}"
      args:
        executable: /bin/bash
      register: picks
      changed_when: false
      check_mode: no
      run_once: true

    - name: Set manifest facts (run once)
      ansible.builtin.set_fact:
        k8s_deb_kubelet: "{{ (picks.stdout_lines | select('match','^kubelet=') | list | first) | regex_replace('^kubelet=','') }}"
        k8s_deb_kubeadm: "{{ (picks.stdout_lines | select('match','^kubeadm=') | list | first) | regex_replace('^kubeadm=','') }}"
        k8s_deb_kubectl: "{{ (picks.stdout_lines | select('match','^kubectl=') | list | first) | regex_replace('^kubectl=','') }}"
        k8s_semver_pinned: "{{ (picks.stdout_lines | select('match','^semver=') | list | first) | regex_replace('^semver=','') }}"
      run_once: true

    - name: Print picked versions
      ansible.builtin.debug:
        msg:
          - "Repo: {{ k8s_repo_url }}"
          - "kubelet: {{ k8s_deb_kubelet }}"
          - "kubeadm: {{ k8s_deb_kubeadm }}"
          - "kubectl: {{ k8s_deb_kubectl }}"
          - "semver:  {{ k8s_semver_pinned }}"
      run_once: true

    - name: Write manifest on controller (commit this)
      ansible.builtin.copy:
        dest: "{{ manifest_path }}"
        mode: "0644"
        content: |
          # Generated from apt repo on {{ ansible_date_time.date }} {{ ansible_date_time.time }}
          k8s_minor_repo: "{{ k8s_minor_repo }}"
          k8s_repo_url: "{{ k8s_repo_url }}"

          k8s_deb_versions:
            kubelet: "{{ k8s_deb_kubelet }}"
            kubeadm: "{{ k8s_deb_kubeadm }}"
            kubectl: "{{ k8s_deb_kubectl }}"

          k8s_semver_pinned: "{{ k8s_semver_pinned }}"
      delegate_to: localhost
      become: false
      run_once: true

