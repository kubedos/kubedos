---
- name: Kubernetes repo bootstrap + version manifest (deb pins)
  hosts: "cp:w"
  gather_facts: false
  become: true
  any_errors_fatal: true

  vars:
    # Effective values (never define a var in terms of itself)
    _k8s_minor_repo: "{{ (k8s_minor_repo | default('v1.35')) | trim }}"
    _k8s_repo_url: "https://pkgs.k8s.io/core:/stable:/{{ _k8s_minor_repo }}/deb/"

    _manifest_path: "{{ (manifest_path | default('/srv/ansible/group_vars/all/k8s_versions.yml')) | trim }}"
    _manifest_stamp: "{{ lookup('ansible.builtin.pipe', 'date -Is') }}"

    fail_patterns:
      - "NO_PUBKEY"
      - "EXPKEYSIG"
      - "signatures were invalid"
      - "is not signed"
      - "Could not resolve"
      - "Temporary failure resolving"
      - "TLS"
      - "Handshake"

  tasks:
    - name: Ensure baseline tooling for repo bootstrap
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - apt-transport-https
        state: present
        update_cache: true
      check_mode: no

    - name: Ensure apt keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"
      check_mode: no

    - name: Fetch Kubernetes repo Release.key
      ansible.builtin.get_url:
        url: "{{ _k8s_repo_url }}Release.key"
        dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
        mode: "0644"
      check_mode: no

    - name: Dearmor Kubernetes key into keyring
      ansible.builtin.command: >
        gpg --batch --yes --dearmor
        -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        /etc/apt/keyrings/kubernetes-apt-keyring.asc
      register: _k8s_key_dearmor
      changed_when: _k8s_key_dearmor.rc == 0
      check_mode: no

    - name: Install Kubernetes apt source list
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        mode: "0644"
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] {{ _k8s_repo_url }} /
      check_mode: no

    - name: Apt update (capture output)
      ansible.builtin.shell: |
        set -euo pipefail
        apt-get update 2>&1 | tee /tmp/apt-update.k8s.log
      args:
        executable: /bin/bash
      register: apt_update_out
      changed_when: false
      check_mode: no

    - name: Fail loudly if Kubernetes repo is not usable (trust/DNS/TLS)
      ansible.builtin.fail:
        msg: |
          Kubernetes apt repo is not usable on {{ inventory_hostname }}.
          Repo: {{ _k8s_repo_url }}

          Filtered apt-get update output:
          {{
            (apt_update_out.stdout_lines
              | select('match', '.*(pkgs\\.k8s\\.io|NO_PUBKEY|EXPKEYSIG|not signed|signatures were invalid|Could not resolve|Temporary failure resolving|TLS|Handshake).*')
              | list
            ) | join('\n')
          }}

          Full log on node: /tmp/apt-update.k8s.log
      when: >
        (fail_patterns | select('in', apt_update_out.stdout) | list | length) > 0

    - name: Resolve newest deb versions from apt (run once)
      ansible.builtin.shell: |
        set -euo pipefail
        pick() {
          local p="$1"
          apt-cache madison "$p" | awk '{print $3}' | LC_ALL=C sort -Vu | tail -n1
        }

        kubelet="$(pick kubelet || true)"
        kubeadm="$(pick kubeadm || true)"
        kubectl="$(pick kubectl || true)"

        if [ -z "${kubelet}" ] || [ -z "${kubeadm}" ] || [ -z "${kubectl}" ]; then
          echo "ERROR: one or more packages not present in apt."
          echo "kubelet='${kubelet}' kubeadm='${kubeadm}' kubectl='${kubectl}'"
          echo
          echo "DEBUG: apt-cache policy kubelet:"
          apt-cache policy kubelet || true
          exit 1
        fi

        echo "kubelet=${kubelet}"
        echo "kubeadm=${kubeadm}"
        echo "kubectl=${kubectl}"
        echo "semver=${kubelet%%-*}"
      args:
        executable: /bin/bash
      register: picks
      changed_when: false
      check_mode: no
      run_once: true

    - name: Set manifest facts (run once)
      ansible.builtin.set_fact:
        _k8s_deb_kubelet: "{{ (picks.stdout_lines | select('match','^kubelet=') | list | first) | regex_replace('^kubelet=','') }}"
        _k8s_deb_kubeadm: "{{ (picks.stdout_lines | select('match','^kubeadm=') | list | first) | regex_replace('^kubeadm=','') }}"
        _k8s_deb_kubectl: "{{ (picks.stdout_lines | select('match','^kubectl=') | list | first) | regex_replace('^kubectl=','') }}"
        _k8s_semver_pinned: "{{ (picks.stdout_lines | select('match','^semver=') | list | first) | regex_replace('^semver=','') }}"
      run_once: true

    - name: Print picked versions (run once)
      ansible.builtin.debug:
        msg:
          - "Repo:    {{ _k8s_repo_url }}"
          - "kubelet: {{ _k8s_deb_kubelet }}"
          - "kubeadm: {{ _k8s_deb_kubeadm }}"
          - "kubectl: {{ _k8s_deb_kubectl }}"
          - "semver:  {{ _k8s_semver_pinned }}"
          - "write:   {{ _manifest_path }}"
      run_once: true

    - name: Write manifest on controller (commit this)
      ansible.builtin.copy:
        dest: "{{ _manifest_path }}"
        mode: "0644"
        content: |
          ---
          # Generated {{ _manifest_stamp }}
          # Source: {{ _k8s_repo_url }}
          #
          # Re-generate:
          #   ansible-playbook -i inventory/hosts.ini tools/k8s_repo_manifest.yml --become
          #
          # Deterministic pins for Kubernetes deb installs.

          k8s_minor_repo: "{{ _k8s_minor_repo }}"
          k8s_repo_url: "{{ _k8s_repo_url }}"

          k8s_deb_versions:
            kubelet: "{{ _k8s_deb_kubelet }}"
            kubeadm: "{{ _k8s_deb_kubeadm }}"
            kubectl: "{{ _k8s_deb_kubectl }}"

          k8s_semver_pinned: "{{ _k8s_semver_pinned }}"
      delegate_to: localhost
      become: false
      run_once: true

