---
- name: Kubernetes repo bootstrap + version manifest (deb pins)
  hosts: "cp:w"
  become: true
  gather_facts: false

  vars:
    k8s_minor_repo_effective: "{{ (k8s_minor_repo is defined) | ternary(k8s_minor_repo, 'v1.35') }}"
    k8s_repo_url_effective: "{{ (k8s_repo_url is defined) | ternary(k8s_repo_url, ('https://pkgs.k8s.io/core:/stable:/' ~ k8s_minor_repo_effective ~ '/deb/')) }}"
    manifest_path_effective: "{{ (manifest_path is defined) | ternary(manifest_path, '/srv/ansible/group_vars/all/k8s_versions.yml') }}"

    k8s_key_tmp: /tmp/kubernetes-Release.key
    k8s_keyring: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    k8s_list: /etc/apt/sources.list.d/kubernetes.list

  tasks:
    - name: Ensure apt keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Stat existing kubernetes.list and keyring
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ k8s_list }}"
        - "{{ k8s_keyring }}"
      register: _k8s_stat

    - name: Set facts from stat results
      ansible.builtin.set_fact:
        _k8s_list_exists: "{{ (_k8s_stat.results | selectattr('item','equalto',k8s_list) | first).stat.exists }}"
        _k8s_keyring_exists: "{{ (_k8s_stat.results | selectattr('item','equalto',k8s_keyring) | first).stat.exists }}"
      changed_when: false

    - name: Remove kubernetes.list if keyring is missing (prevents apt update failure)
      ansible.builtin.file:
        path: "{{ k8s_list }}"
        state: absent
      when: _k8s_list_exists and (not _k8s_keyring_exists)

    - name: Apt update (show real errors)
      ansible.builtin.command: bash -lc "DEBIAN_FRONTEND=noninteractive apt-get update"
      args:
        executable: /bin/bash
      register: _apt_update_pre
      changed_when: false
      retries: 5
      delay: 3
      until: _apt_update_pre.rc == 0

    - name: Ensure baseline tooling for repo bootstrap
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: false

    - name: Fetch Kubernetes repo Release.key
      ansible.builtin.get_url:
        url: "{{ k8s_repo_url_effective }}Release.key"
        dest: "{{ k8s_key_tmp }}"
        mode: "0644"
        force: true

    - name: Dearmor Kubernetes key into keyring (non-interactive, idempotent)
      ansible.builtin.shell: |
        set -euo pipefail
        tmp="$(mktemp)"
        gpg --dearmor --batch --yes --no-tty -o "$tmp" "{{ k8s_key_tmp }}"
        chmod 0644 "$tmp"
        if [ -f "{{ k8s_keyring }}" ] && cmp -s "$tmp" "{{ k8s_keyring }}"; then
          rm -f "$tmp"
          echo "unchanged"
        else
          install -m 0644 "$tmp" "{{ k8s_keyring }}"
          rm -f "$tmp"
          echo "updated"
        fi
      args:
        executable: /bin/bash
      register: _k8s_keyring_update
      changed_when: "'updated' in _k8s_keyring_update.stdout"

    - name: Install Kubernetes apt source list
      ansible.builtin.copy:
        dest: "{{ k8s_list }}"
        mode: "0644"
        content: |
          deb [signed-by={{ k8s_keyring }}] {{ k8s_repo_url_effective }} /

    - name: Apt update after adding Kubernetes repo (show real errors)
      ansible.builtin.command: bash -lc "DEBIAN_FRONTEND=noninteractive apt-get update"
      args:
        executable: /bin/bash
      register: _apt_update_post
      changed_when: false

    - name: Fail loudly if Kubernetes repo is not usable
      ansible.builtin.fail:
        msg: |
          Kubernetes repo not usable on {{ inventory_hostname }}.
          Repo: {{ k8s_repo_url_effective }}
          apt-get update output:
          {{ _apt_update_post.stdout | default('') }}
          {{ _apt_update_post.stderr | default('') }}
      when: _apt_update_post.rc != 0

    - name: Resolve newest deb versions from apt (run once, on first CP)
      ansible.builtin.shell: |
        set -euo pipefail
        kubelet="$(apt-cache madison kubelet | awk '{print $3}' | head -n1)"
        kubeadm="$(apt-cache madison kubeadm | awk '{print $3}' | head -n1)"
        kubectl="$(apt-cache madison kubectl | awk '{print $3}' | head -n1)"
        echo "kubelet=${kubelet}"
        echo "kubeadm=${kubeadm}"
        echo "kubectl=${kubectl}"
      args:
        executable: /bin/bash
      register: _k8s_madison
      changed_when: false
      run_once: true
      delegate_to: "{{ (groups['cp'] | default([]) | first) | default(inventory_hostname) }}"

    - name: Parse versions from apt-cache output (controller fact)
      ansible.builtin.set_fact:
        _kubelet_ver: "{{ (_k8s_madison.stdout_lines | select('match','^kubelet=') | first | regex_replace('^kubelet=','')) }}"
        _kubeadm_ver: "{{ (_k8s_madison.stdout_lines | select('match','^kubeadm=') | first | regex_replace('^kubeadm=','')) }}"
        _kubectl_ver: "{{ (_k8s_madison.stdout_lines | select('match','^kubectl=') | first | regex_replace('^kubectl=','')) }}"
        _k8s_semver: "{{ ((_k8s_madison.stdout_lines | select('match','^kubeadm=') | first | regex_replace('^kubeadm=','')) | regex_replace('-.*$','')) }}"
      changed_when: false
      run_once: true
      delegate_to: localhost

    - name: Write k8s deb version manifest for deterministic installs
      ansible.builtin.copy:
        dest: "{{ manifest_path_effective }}"
        mode: "0644"
        content: |
          # Auto-generated by tools/k8s_repo_manifest.yml
          k8s_minor_repo: "{{ k8s_minor_repo_effective }}"
          k8s_repo_url: "{{ k8s_repo_url_effective }}"

          k8s_deb_versions:
            kubelet: "{{ _kubelet_ver }}"
            kubeadm: "{{ _kubeadm_ver }}"
            kubectl: "{{ _kubectl_ver }}"

          k8s_semver_pinned: "{{ _k8s_semver }}"
      delegate_to: localhost
      run_once: true
      become: false

