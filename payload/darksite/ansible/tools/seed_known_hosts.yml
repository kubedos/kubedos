sudo su - ansible
mkdir -p /srv/ansible/tools

cat > /srv/ansible/tools/seed_known_hosts.yml <<'YAML'
---
- name: Seed controller known_hosts for cluster nodes (optional)
  hosts: localhost
  gather_facts: false

  vars:
    # Inventory hostnames (exclude localhost)
    seed_hosts: "{{ groups['all'] | difference(['localhost']) | sort }}"

  tasks:
    - name: Ensure ~/.ssh exists
      ansible.builtin.file:
        path: "{{ lookup('env','HOME') }}/.ssh"
        state: directory
        mode: "0700"

    - name: Build scan targets (inventory name + ansible_host fallback)
      ansible.builtin.set_fact:
        scan_targets: >-
          {{
            seed_hosts
            | map('regex_replace', '^(.*)$', '\\1')
            | map('community.general.dict_kv', 'name')
            | list
          }}
      vars:
        # avoid requiring extra plugins by rebuilding in next task
        _noop: true

    - name: Rebuild scan_targets without extra filters/plugins
      ansible.builtin.set_fact:
        scan_targets: "{{ scan_targets | default([]) + [ {'name': item, 'addr': (hostvars[item].ansible_host | default(item))} ] }}"
      loop: "{{ seed_hosts }}"

    - name: Scan host key (ed25519) using name, fallback to addr
      ansible.builtin.shell: |
        set -euo pipefail
        ssh-keyscan -T 5 -t ed25519 {{ item.name }} 2>/dev/null \
          || ssh-keyscan -T 5 -t ed25519 {{ item.addr }} 2>/dev/null \
          || true
      args:
        executable: /bin/bash
      register: scan_out
      changed_when: false
      failed_when: false
      loop: "{{ scan_targets }}"

    - name: Add scanned keys to known_hosts (only when we got output)
      ansible.builtin.known_hosts:
        path: "{{ lookup('env','HOME') }}/.ssh/known_hosts"
        name: "{{ item.item.name }}"
        key: "{{ item.stdout }}"
        state: present
      loop: "{{ scan_out.results }}"
      when: item.stdout is defined and (item.stdout | length) > 0
YAML

