---
- name: Generate etcd PKI artifacts on controller
  hosts: etcd
  gather_facts: true
  become: false

  vars:
    etcd_pki_root: /srv/ansible/artifacts/etcd-pki
    etcd_ca_cn: etcd-ca
    etcd_ca_days: 3650
    etcd_cert_days: 3650

  pre_tasks:
    - name: Set cluster management IP fact (WireGuard / 10.78)
      ansible.builtin.set_fact:
        cluster_mgmt_ip: "{{ ansible_host | default(ansible_default_ipv4.address) }}"

    - name: Set cluster underlay IP fact (default route address)
      ansible.builtin.set_fact:
        underlay_ip: "{{ ansible_default_ipv4.address }}"

  tasks:
    - name: Ensure PKI root exists on controller
      ansible.builtin.file:
        path: "{{ etcd_pki_root }}"
        state: directory
        mode: "0700"
      delegate_to: localhost
      run_once: true

    - name: Render OpenSSL extension file template (peer/server)
      ansible.builtin.copy:
        dest: "{{ etcd_pki_root }}/openssl-etcd-ext.cnf"
        mode: "0600"
        content: |
          [ v3_req ]
          basicConstraints = CA:FALSE
          keyUsage = critical, digitalSignature, keyEncipherment
          extendedKeyUsage = serverAuth, clientAuth
          subjectAltName = @alt_names

          [ alt_names ]
          {{ alt_names_block }}
      delegate_to: localhost
      run_once: true
      vars:
        # Placeholder; we rewrite per host below by copying content into a host-specific file.
        alt_names_block: "DNS.1 = placeholder"

    - name: Ensure per-node PKI dirs exist on controller
      ansible.builtin.file:
        path: "{{ etcd_pki_root }}/{{ inventory_hostname }}"
        state: directory
        mode: "0700"
      delegate_to: localhost

    - name: Generate CA key if missing
      ansible.builtin.command: >
        openssl genrsa -out {{ etcd_pki_root }}/ca.key 4096
      args:
        creates: "{{ etcd_pki_root }}/ca.key"
      delegate_to: localhost
      run_once: true

    - name: Generate CA cert if missing
      ansible.builtin.command: >
        openssl req -x509 -new -nodes
        -key {{ etcd_pki_root }}/ca.key
        -subj /CN={{ etcd_ca_cn }}
        -days {{ etcd_ca_days }}
        -out {{ etcd_pki_root }}/ca.crt
      args:
        creates: "{{ etcd_pki_root }}/ca.crt"
      delegate_to: localhost
      run_once: true

    - name: Build SAN list for this node
      ansible.builtin.set_fact:
        etcd_sans:
          - "DNS:{{ inventory_hostname }}"
          - "DNS:{{ inventory_hostname.split('.')[0] }}"
          - "IP:{{ underlay_ip }}"
          - "IP:{{ cluster_mgmt_ip }}"
          - "IP:127.0.0.1"

    - name: Render node-specific OpenSSL ext file (peer/server)
      ansible.builtin.copy:
        dest: "{{ etcd_pki_root }}/{{ inventory_hostname }}/openssl-ext.cnf"
        mode: "0600"
        content: |
          [ v3_req ]
          basicConstraints = CA:FALSE
          keyUsage = critical, digitalSignature, keyEncipherment
          extendedKeyUsage = serverAuth, clientAuth
          subjectAltName = @alt_names

          [ alt_names ]
          {% for san in etcd_sans %}
          {% if san.startswith('DNS:') %}
          DNS.{{ loop.index }} = {{ san[4:] }}
          {% else %}
          IP.{{ loop.index }} = {{ san[3:] }}
          {% endif %}
          {% endfor %}
      delegate_to: localhost

    - name: Generate peer private key if missing
      ansible.builtin.command: >
        openssl genrsa -out {{ etcd_pki_root }}/{{ inventory_hostname }}/peer.key 2048
      args:
        creates: "{{ etcd_pki_root }}/{{ inventory_hostname }}/peer.key"
      delegate_to: localhost

    - name: Generate peer CSR if missing
      ansible.builtin.command: >
        openssl req -new
        -key {{ etcd_pki_root }}/{{ inventory_hostname }}/peer.key
        -subj /CN={{ inventory_hostname }}
        -out {{ etcd_pki_root }}/{{ inventory_hostname }}/peer.csr
      args:
        creates: "{{ etcd_pki_root }}/{{ inventory_hostname }}/peer.csr"
      delegate_to: localhost

    - name: Sign peer cert with CA if missing
      ansible.builtin.command: >
        openssl x509 -req
        -in {{ etcd_pki_root }}/{{ inventory_hostname }}/peer.csr
        -CA {{ etcd_pki_root }}/ca.crt
        -CAkey {{ etcd_pki_root }}/ca.key
        -CAcreateserial
        -out {{ etcd_pki_root }}/{{ inventory_hostname }}/peer.crt
        -days {{ etcd_cert_days }}
        -extensions v3_req
        -extfile {{ etcd_pki_root }}/{{ inventory_hostname }}/openssl-ext.cnf
      args:
        creates: "{{ etcd_pki_root }}/{{ inventory_hostname }}/peer.crt"
      delegate_to: localhost

    - name: Generate server private key if missing
      ansible.builtin.command: >
        openssl genrsa -out {{ etcd_pki_root }}/{{ inventory_hostname }}/server.key 2048
      args:
        creates: "{{ etcd_pki_root }}/{{ inventory_hostname }}/server.key"
      delegate_to: localhost

    - name: Generate server CSR if missing
      ansible.builtin.command: >
        openssl req -new
        -key {{ etcd_pki_root }}/{{ inventory_hostname }}/server.key
        -subj /CN={{ inventory_hostname }}
        -out {{ etcd_pki_root }}/{{ inventory_hostname }}/server.csr
      args:
        creates: "{{ etcd_pki_root }}/{{ inventory_hostname }}/server.csr"
      delegate_to: localhost

    - name: Sign server cert with CA if missing
      ansible.builtin.command: >
        openssl x509 -req
        -in {{ etcd_pki_root }}/{{ inventory_hostname }}/server.csr
        -CA {{ etcd_pki_root }}/ca.crt
        -CAkey {{ etcd_pki_root }}/ca.key
        -CAcreateserial
        -out {{ etcd_pki_root }}/{{ inventory_hostname }}/server.crt
        -days {{ etcd_cert_days }}
        -extensions v3_req
        -extfile {{ etcd_pki_root }}/{{ inventory_hostname }}/openssl-ext.cnf
      args:
        creates: "{{ etcd_pki_root }}/{{ inventory_hostname }}/server.crt"
      delegate_to: localhost

    - name: Tighten permissions on generated private keys
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "0600"
      loop:
        - "{{ etcd_pki_root }}/ca.key"
        - "{{ etcd_pki_root }}/{{ inventory_hostname }}/peer.key"
        - "{{ etcd_pki_root }}/{{ inventory_hostname }}/server.key"
      delegate_to: localhost
