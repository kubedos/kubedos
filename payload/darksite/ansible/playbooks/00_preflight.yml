- name: Preflight - sanity checks + bootstrap requirements
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Ensure python3 exists
      raw: |
        set -e
        command -v python3 >/dev/null || (apt-get update && apt-get install -y python3)
      changed_when: false

    - name: Re-gather facts now that python exists
      setup:

    - name: Ensure salt-minion is installed
      apt:
        name:
          - salt-minion
          - salt-common
        state: present
        update_cache: true

    - name: Ensure salt-minion service is enabled + running
      systemd:
        name: salt-minion
        enabled: true
        state: started

    - name: Verify salt-call exists
      command: salt-call --version
      register: salt_version
      changed_when: false

    - name: Show salt-call version
      debug:
        msg: "{{ salt_version.stdout }}"

    - name: Create compatibility salt client wrapper (optional)
      copy:
        dest: /usr/local/bin/salt
        mode: "0755"
        content: |
          #!/bin/sh
          exec /usr/bin/salt-call "$@"
      when: ansible_facts['os_family'] == "Debian"

    - name: Assert required DNS vars exist
      assert:
        that:
          - dns_update_server is defined
          - dns_update_zone is defined
          - dns_update_key is defined
        fail_msg: >
          Missing required DNS vars. Define dns_update_server, dns_update_zone,
          and dns_update_key in group_vars/all.yml

