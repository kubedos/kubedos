---
- name: Install Helm (package manager) on bootstrap control-plane
  hosts: cp-1.unixbox.net
  become: true
  gather_facts: false
  vars:
    helm_version: "v3.16.4"
    helm_arch: "amd64"
    helm_bin: "/usr/local/bin/helm"
    helm_tgz: "/tmp/helm.tgz"
  tasks:
    - name: Ensure curl present
      apt:
        name: [curl, ca-certificates]
        state: present
        update_cache: true

    - name: Check existing helm version (if any)
      command: "{{ helm_bin }} version --short"
      register: helm_ver
      changed_when: false
      failed_when: false

    - name: Download helm archive
      get_url:
        url: "https://get.helm.sh/helm-{{ helm_version }}-linux-{{ helm_arch }}.tar.gz"
        dest: "{{ helm_tgz }}"
        mode: "0644"
      when: helm_ver.rc != 0 or (helm_version not in helm_ver.stdout)

    - name: Install helm binary
      shell: |
        set -euo pipefail
        tar -xzf {{ helm_tgz }} -C /tmp
        install -m 0755 /tmp/linux-{{ helm_arch }}/helm {{ helm_bin }}
      args:
        executable: /bin/bash
      when: helm_ver.rc != 0 or (helm_version not in helm_ver.stdout)

    - name: Verify helm installed
      command: "{{ helm_bin }} version --short"
      changed_when: false

